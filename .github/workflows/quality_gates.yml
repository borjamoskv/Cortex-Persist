# CORTEX Quality Gates â€” 7-seal CI enforcement
# Leap 1: Makes guards mandatory via CI, not discipline

name: "ğŸ”’ Quality Gates"

on:
  pull_request:
    branches: [master, main]
  push:
    branches: [master, main]

concurrency:
  group: quality-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-gates:
    name: "7 Seals"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install CORTEX + dev deps
        run: |
          pip install -e ".[dev]" --quiet

      # â”€â”€â”€ Gate 1: Lint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ” Gate 1: Lint (Ruff)"
        run: ruff check cortex/ --output-format=github

      # â”€â”€â”€ Gate 2: Type Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ” Gate 2: Type Check (mypy)"
        run: |
          pip install mypy --quiet
          mypy cortex/ --ignore-missing-imports --no-error-summary || true
        continue-on-error: true  # Warning-only for now

      # â”€â”€â”€ Gate 3: Security Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ” Gate 3: Security Scan (bandit)"
        run: |
          pip install bandit --quiet
          bandit -r cortex/ -c pyproject.toml --severity-level medium -f json -o bandit-report.json || true
          bandit -r cortex/ -c pyproject.toml --severity-level high

      # â”€â”€â”€ Gate 4: Test Coverage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ” Gate 4: Tests + Coverage"
        run: |
          python -m pytest tests/ \
            --cov=cortex \
            --cov-fail-under=70 \
            --tb=short \
            -x -q \
            --timeout=60

      # â”€â”€â”€ Gate 5: Ledger Integrity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ” Gate 5: Ledger Integrity"
        run: |
          python -c "
          from cortex.engine import CortexEngine
          import asyncio
          async def check():
              engine = CortexEngine(':memory:', auto_embed=False)
              await engine.init_db()
              print('âœ… Ledger schema initialized successfully')
              await engine.close()
          asyncio.run(check())
          "

      # â”€â”€â”€ Gate 6: Connection Guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ” Gate 6: Connection Guard"
        run: python -m cortex.database.connection_guard --root cortex

      # â”€â”€â”€ Gate 7: Prompt Size Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ” Gate 7: Prompt Size (warning only)"
        run: |
          if [ -f "SYSTEM_PROMPT.md" ]; then
            TOKENS=$(wc -w < SYSTEM_PROMPT.md)
            echo "System prompt: $TOKENS words"
            if [ "$TOKENS" -gt 500 ]; then
              echo "âš ï¸  WARNING: System prompt is $TOKENS words (target: <200 tokens)"
            else
              echo "âœ… System prompt is within target"
            fi
          else
            echo "â„¹ï¸  No SYSTEM_PROMPT.md found (expected in Leap 2)"
          fi
        continue-on-error: true
